<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet + GeoRasterLayer (COG)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <style>html,body,#map{height:100%;margin:0}</style>
</head>
<body>
  <div id="map"></div>

  <!-- JS (use jsDelivr to avoid unpkg 404/nosniff) -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4leaflet@1.0.2/dist/proj4leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/georaster@1.7.3/dist/georaster.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/georaster-layer-for-leaflet@3.12.0/dist/georaster-layer-for-leaflet.min.js"></script>

  <script>
  const url = "https://aeromap.io/201209N_geo_COG.tif";

  // Base map
  const map = L.map("map").setView([20, 0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors", maxZoom: 19
  }).addTo(map);

  // Helper: define EPSG automatically when itâ€™s a common one
  function ensureProjDef(epsg) {
    if (!epsg || typeof epsg !== "string") return;

    // Known basics
    if (epsg === "EPSG:4326" && !proj4.defs["EPSG:4326"]) {
      proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs +type=crs");
    }
    if (epsg === "EPSG:3857" && !proj4.defs["EPSG:3857"]) {
      proj4.defs("EPSG:3857", "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +type=crs");
    }

    // UTM WGS84 north (EPSG:326##) or south (EPSG:327##)
    const m = epsg.match(/^EPSG:(326|327)(\d{2})$/);
    if (m) {
      const hemi = m[1] === "326" ? "north" : "south";
      const zone = parseInt(m[2], 10);
      if (!proj4.defs[epsg]) {
        const southFlag = (hemi === "south") ? " +south" : "";
        proj4.defs(epsg, `+proj=utm +zone=${zone}${southFlag} +datum=WGS84 +units=m +no_defs +type=crs`);
      }
    }
  }

  parseGeoraster(url).then(georaster => {
    console.log("projection from COG:", georaster.projection);

    // If the COG reports an EPSG code, define it if proj4 doesn't know it yet.
    ensureProjDef(georaster.projection);

    const layer = new GeoRasterLayer({
      georaster,
      opacity: 0.9,
      resolution: 256
    }).addTo(map);

    layer.once("load", () => {
      try {
        const b = layer.getBounds();
        if (b && b.isValid()) map.fitBounds(b, { padding: [20, 20] });
      } catch(e) {
        console.warn("Bounds error:", e);
      }
    });
  }).catch(err => {
    console.error("Raster load error:", err);
    alert("Raster load error. See console.");
  });
  </script>
</body>
</html>
