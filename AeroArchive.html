<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DFW Sectionals – Layer Viewer + Animation</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
    }
    /* Simple style for the animation control */
    .anim-control {
      background: white;
      padding: 6px 8px;
      font-family: sans-serif;
      font-size: 12px;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
      border-radius: 4px;
    }
    .anim-control button {
      margin: 0 2px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .anim-control span {
      margin-left: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ------------------------------
// TiTiler base URL
// ------------------------------
const titiler = "https://titiler-production.up.railway.app";

// ------------------------------
// Helper: encoded aeromap.io URL
// ------------------------------
function buildEncodedCogUrl(filename) {
  return encodeURIComponent("https://aeromap.io/" + filename);
}

// ------------------------------
// Your list of COG files (ordered frames)
// ------------------------------
const cogFiles = [
  "201109N_geo_COG.tif",
  "201109S_geo_COG.tif",
  "201209N_geo_COG.tif",
  "201209S_geo_COG.tif",
  "201309N_geo_COG.tif",
  "201309S_geo_COG.tif",
  "201403_geo_COG.tif",
  "201503_geo_COG.tif",
  "201603_geo_COG.tif",
  "201609_geo_COG.tif"
];

// Human-readable labels for display (no “COG ” prefix)
const cogLabels = cogFiles.map(f => f.replace(/\.tit$/, ".tif"));

// ------------------------------
// Initialize map
// ------------------------------
const dfwBounds = L.latLngBounds(
  [32.3, -98.0],  // SW
  [33.3, -96.5]   // NE
);
const dfwCenter = dfwBounds.getCenter();

const map = L.map("map", {
  center: dfwCenter,
  zoom: 11,
  worldCopyJump: false
});

// Base OSM layer
const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 22,
    noWrap: true
  }
).addTo(map);

// ------------------------------
// Create COG overlay layers
// ------------------------------
const cogLayers = {};
const overlayLabels = []; // "COG <filename>" labels for the layer control & animation
let defaultLayer = null;

cogFiles.forEach((filename, idx) => {
  const label = "COG " + cogLabels[idx];
  overlayLabels.push(label);

  const encoded = buildEncodedCogUrl(filename);
  const url = `${titiler}/cog/tiles/WebMercatorQuad/{z}/{x}/{y}.png?url=${encoded}`;

  const layer = L.tileLayer(url, {
    tileSize: 256,
    maxZoom: 22,
    noWrap: true,
    // Transparent 1x1 PNG for missing tiles so errors aren't ugly
    errorTileUrl:
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR4nGP8z8BQDwAD3gG7miRCNQAAAABJRU5ErkJggg=="
  });

  cogLayers[label] = layer;
  defaultLayer = layer; // remember the last one
});

// Turn on ONLY the last COG by default (201609)
if (defaultLayer) {
  defaultLayer.addTo(map);
}

// ------------------------------
// Layer control (OSM + all COGs)
// ------------------------------
L.control.layers(
  { "OpenStreetMap": osm },
  cogLayers,
  { collapsed: false }
).addTo(map);

// Debug: see what overlays we registered
console.log("COG overlay layers:", overlayLabels);

// ------------------------------
// SIMPLE ANIMATION (no TimeDimension)
// ------------------------------
let currentIndex = overlayLabels.length - 1; // start on last frame
let isPlaying = false;
let playTimer = null;
const frameDuration = 800; // ms between frames; adjust speed here

let animPlayButton = null;
let animLabelSpan = null;

// Show only the layer at the given index
function showFrame(index) {
  if (index < 0 || index >= overlayLabels.length) return;
  currentIndex = index;

  // Remove all COG layers
  overlayLabels.forEach(label => {
    const layer = cogLayers[label];
    if (layer && map.hasLayer(layer)) {
      map.removeLayer(layer);
    }
  });

  // Add the current one
  const currentLabel = overlayLabels[currentIndex];
  const currentLayer = cogLayers[currentLabel];
  if (currentLayer) {
    currentLayer.addTo(map);
  }

  // Update text in the animation control
  if (animLabelSpan) {
    animLabelSpan.textContent = cogLabels[currentIndex];
  }

  console.log("Showing frame:", currentLabel);
}

// Step forward / backward
function nextFrame() {
  const next = (currentIndex + 1) % overlayLabels.length;
  showFrame(next);
}
function prevFrame() {
  const prev = (currentIndex - 1 + overlayLabels.length) % overlayLabels.length;
  showFrame(prev);
}

// Play / pause
function startPlaying() {
  if (isPlaying) return;
  isPlaying = true;
  if (animPlayButton) animPlayButton.textContent = "Pause";
  playTimer = setInterval(nextFrame, frameDuration);
}
function stopPlaying() {
  if (!isPlaying) return;
  isPlaying = false;
  if (animPlayButton) animPlayButton.textContent = "Play";
  if (playTimer) {
    clearInterval(playTimer);
    playTimer = null;
  }
}
function togglePlaying() {
  if (isPlaying) {
    stopPlaying();
  } else {
    startPlaying();
  }
}

// ------------------------------
// Custom Leaflet control for animation UI
// ------------------------------
const AnimationControl = L.Control.extend({
  options: {
    position: "bottomleft"
  },
  onAdd: function () {
    const container = L.DomUtil.create("div", "anim-control");

    // Prevent map from reacting to clicks on the control
    L.DomEvent.disableClickPropagation(container);

    // Play / Pause button
    const playBtn = L.DomUtil.create("button", "", container);
    playBtn.textContent = "Play";
    playBtn.onclick = function () {
      togglePlaying();
    };
    animPlayButton = playBtn;

    // Prev button
    const prevBtn = L.DomUtil.create("button", "", container);
    prevBtn.textContent = "◀";
    prevBtn.onclick = function () {
      stopPlaying();
      prevFrame();
    };

    // Next button
    const nextBtn = L.DomUtil.create("button", "", container);
    nextBtn.textContent = "▶";
    nextBtn.onclick = function () {
      stopPlaying();
      nextFrame();
    };

    // Label showing current frame
    const labelSpan = L.DomUtil.create("span", "", container);
    labelSpan.textContent = cogLabels[currentIndex];
    animLabelSpan = labelSpan;

    return container;
  }
});

// Add the animation control to the map
map.addControl(new AnimationControl());

// Make sure currentIndex frame is actually visible on load
showFrame(currentIndex);
</script>
</body>
</html>
