<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DFW Sectionals – Year Animation</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
    }
    /* Simple style for the animation control */
    .anim-control {
      background: white;
      padding: 6px 8px;
      font-family: sans-serif;
      font-size: 12px;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
      border-radius: 4px;
    }
    .anim-control button {
      margin: 0 2px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .anim-control span {
      margin-left: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ------------------------------
// TiTiler base URL
// ------------------------------
const titiler = "https://titiler-production.up.railway.app";

// ------------------------------
// Helper: encoded aeromap.io URL
// ------------------------------
function buildEncodedCogUrl(filename) {
  return encodeURIComponent("https://aeromap.io/" + filename);
}

// ------------------------------
// All COG files (individual layers)
// ------------------------------
const cogFiles = [
  "201109N_geo_COG.tif",
  "201109S_geo_COG.tif",
  "201209N_geo_COG.tif",
  "201209S_geo_COG.tif",
  "201309N_geo_COG.tif",
  "201309S_geo_COG.tif",
  "201403_geo_COG.tif",
  "201503_geo_COG.tif",
  "201603_geo_COG.tif",
  "201609_geo_COG.tif"
];

// For pretty labels in UI if needed
const cogLabelsByFile = {};
cogFiles.forEach(f => {
  cogLabelsByFile[f] = f.replace(/\.tit$/, ".tif");
});

// ------------------------------
// Initialize map (no fade animations)
// ------------------------------
const dfwBounds = L.latLngBounds(
  [32.3, -98.0],  // SW
  [33.3, -96.5]   // NE
);
const dfwCenter = dfwBounds.getCenter();

const map = L.map("map", {
  center: dfwCenter,
  zoom: 11,
  worldCopyJump: false,
  fadeAnimation: false,
  zoomAnimation: false
});

// Base OSM layer
const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 22,
    noWrap: true
  }
).addTo(map);

// ------------------------------
// Create COG overlay layers (one per file)
// ------------------------------
const cogLayers = {};
let defaultLayer = null;

cogFiles.forEach((filename) => {
  const label = "COG " + cogLabelsByFile[filename];

  const encoded = buildEncodedCogUrl(filename);
  const url = `${titiler}/cog/tiles/WebMercatorQuad/{z}/{x}/{y}.png?url=${encoded}`;

  const layer = L.tileLayer(url, {
    tileSize: 256,
    maxZoom: 22,
    noWrap: true,
    // Transparent 1x1 PNG for missing tiles
    errorTileUrl:
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR4nGP8z8BQDwAD3gG7miRCNQAAAABJRU5ErkJggg=="
  });

  cogLayers[label] = layer;
  defaultLayer = layer; // last one: 201609
});

// Turn on ONLY the last COG by default (201609)
if (defaultLayer) {
  defaultLayer.addTo(map);
}

// ------------------------------
// Layer control (OSM + all COGs)
// ------------------------------
L.control.layers(
  { "OpenStreetMap": osm },
  cogLayers,
  { collapsed: false }
).addTo(map);

// ------------------------------
// YEAR-GROUPED FRAMES for animation
// Each frame has: label, and a list of COG layer keys to show together
// ------------------------------
const frames = [
  {
    label: "2011",
    layerKeys: [
      "COG " + cogLabelsByFile["201109N_geo_COG.tif"],
      "COG " + cogLabelsByFile["201109S_geo_COG.tif"]
    ]
  },
  {
    label: "2012",
    layerKeys: [
      "COG " + cogLabelsByFile["201209N_geo_COG.tif"],
      "COG " + cogLabelsByFile["201209S_geo_COG.tif"]
    ]
  },
  {
    label: "2013",
    layerKeys: [
      "COG " + cogLabelsByFile["201309N_geo_COG.tif"],
      "COG " + cogLabelsByFile["201309S_geo_COG.tif"]
    ]
  },
  {
    label: "2014",
    layerKeys: [
      "COG " + cogLabelsByFile["201403_geo_COG.tif"]
    ]
  },
  {
    label: "2015",
    layerKeys: [
      "COG " + cogLabelsByFile["201503_geo_COG.tif"]
    ]
  },
  {
    label: "2016-03",
    layerKeys: [
      "COG " + cogLabelsByFile["201603_geo_COG.tif"]
    ]
  },
  {
    label: "2016-09",
    layerKeys: [
      "COG " + cogLabelsByFile["201609_geo_COG.tif"]
    ]
  }
];

// ------------------------------
// SIMPLE ANIMATION (no TimeDimension)
// ------------------------------
let currentIndex = frames.length - 1; // start on the last frame (2016-09)
let isPlaying = false;
let playTimer = null;
const frameDuration = 800; // ms between frames

let animPlayButton = null;
let animLabelSpan = null;

// Show only the layers in the given frame index
function showFrame(index) {
  if (index < 0 || index >= frames.length) return;
  currentIndex = index;

  // Remove ALL COG layers from map
  Object.values(cogLayers).forEach(layer => {
    if (map.hasLayer(layer)) {
      map.removeLayer(layer);
    }
  });

  // Add layers for this frame
  const frame = frames[currentIndex];
  frame.layerKeys.forEach(key => {
    const layer = cogLayers[key];
    if (layer) layer.addTo(map);
  });

  // Update label text in animation control
  if (animLabelSpan) {
    animLabelSpan.textContent = frame.label;
  }

  console.log("Showing frame:", frame.label, frame.layerKeys);
}

// Step forward / backward
function nextFrame() {
  const next = (currentIndex + 1) % frames.length;
  showFrame(next);
}
function prevFrame() {
  const prev = (currentIndex - 1 + frames.length) % frames.length;
  showFrame(prev);
}

// Play / pause
function startPlaying() {
  if (isPlaying) return;
  isPlaying = true;
  if (animPlayButton) animPlayButton.textContent = "Pause";
  playTimer = setInterval(nextFrame, frameDuration);
}
function stopPlaying() {
  if (!isPlaying) return;
  isPlaying = false;
  if (animPlayButton) animPlayButton.textContent = "Play";
  if (playTimer) {
    clearInterval(playTimer);
    playTimer = null;
  }
}
function togglePlaying() {
  if (isPlaying) {
    stopPlaying();
  } else {
    startPlaying();
  }
}

// ------------------------------
// Custom Leaflet control for animation UI
// ------------------------------
const AnimationControl = L.Control.extend({
  options: {
    position: "bottomleft"
  },
  onAdd: function () {
    const container = L.DomUtil.create("div", "anim-control");

    // prevent map interactions from clicks on control
    L.DomEvent.disableClickPropagation(container);

    // Play / Pause
    const playBtn = L.DomUtil.create("button", "", container);
    playBtn.textContent = "Play";
    playBtn.onclick = function () {
      togglePlaying();
    };
    animPlayButton = playBtn;

    // Prev
    const prevBtn = L.DomUtil.create("button", "", container);
    prevBtn.textContent = "◀";
    prevBtn.onclick = function () {
      stopPlaying();
      prevFrame();
    };

    // Next
    const nextBtn = L.DomUtil.create("button", "", container);
    nextBtn.textContent = "▶";
    nextBtn.onclick = function () {
      stopPlaying();
      nextFrame();
    };

    // Label
    const labelSpan = L.DomUtil.create("span", "", container);
    labelSpan.textContent = frames[currentIndex].label;
    animLabelSpan = labelSpan;

    return container;
  }
});

// Add the control and sync frame on load
map.addControl(new AnimationControl());
showFrame(currentIndex);
</script>
</body>
</html>
