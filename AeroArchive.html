<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DFW Sectionals – TimeDimension</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- TimeDimension CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- TimeDimension deps -->
<script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.min.js"></script>

<script>
// ------------------------------
// TiTiler base URL
// ------------------------------
const titiler = "https://titiler-production.up.railway.app";

// ------------------------------
// Helper: encoded aeromap.io URL
// ------------------------------
function buildEncodedCogUrl(filename) {
  return encodeURIComponent("https://aeromap.io/" + filename);
}

// ------------------------------
// Your list of COG files (in temporal order)
// ------------------------------
const cogFiles = [
  "201109N_geo_COG.tif",
  "201109S_geo_COG.tif",
  "201209N_geo_COG.tif",
  "201209S_geo_COG.tif",
  "201309N_geo_COG.tif",
  "201309S_geo_COG.tif",
  "201403_geo_COG.tif",
  "201503_geo_COG.tif",
  "201603_geo_COG.tif",
  "201609_geo_COG.tif"
];

// Human-readable labels, if we want to log or show them
const cogLabels = cogFiles.map(f => f.replace(/\.tit$/, ".tif"));

// ------------------------------
// Build TimeDimension times from filenames
// YYYYMM -> YYYY-MM-01T00:00:00Z
// ------------------------------
function dateFromFilename(filename) {
  const match = filename.match(/^(\d{4})(\d{2})/);
  if (!match) return null;
  const year = match[1];
  const month = match[2];
  return `${year}-${month}-01T00:00:00Z`;
}

const timeStrings = cogFiles.map(dateFromFilename);
const timeMs = timeStrings.map(t => new Date(t).getTime());

// ------------------------------
// TimeDimension object
// ------------------------------
console.log("L.TimeDimension is", typeof L.TimeDimension);

const timeDimension = new L.TimeDimension({
  times: timeStrings,          // array of ISO strings
  currentTime: timeMs[0]       // start at first
});

// ------------------------------
// Initialize map
// ------------------------------
const dfwBounds = L.latLngBounds(
  [32.3, -98.0],  // SW
  [33.3, -96.5]   // NE
);
const dfwCenter = dfwBounds.getCenter();

const map = L.map("map", {
  center: dfwCenter,
  zoom: 11,
  worldCopyJump: false,
  timeDimension: timeDimension,
  timeDimensionControl: true  // adds the slider + play/stop controls
});

// Base OSM layer
const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 22,
    noWrap: true
  }
).addTo(map);

// ------------------------------
// Single COG tile layer – URL swapped on timechange
// ------------------------------
function makeCogUrl(encoded) {
  return `${titiler}/cog/tiles/WebMercatorQuad/{z}/{x}/{y}.png?url=${encoded}`;
}

// start with first frame
let currentIndex = 0;
let currentEncodedUrl = buildEncodedCogUrl(cogFiles[currentIndex]);

const cogLayer = L.tileLayer(makeCogUrl(currentEncodedUrl), {
  tileSize: 256,
  maxZoom: 22,
  noWrap: true,
  errorTileUrl:
    "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR4nGP8z8BQDwAD3gG7miRCNQAAAABJRU5ErkJggg=="
}).addTo(map);

// Optional: layer control just to toggle the raster on/off
L.control.layers(
  { "OpenStreetMap": osm },
  { "DFW Sectional": cogLayer },
  { collapsed: false }
).addTo(map);

// ------------------------------
// Handle TimeDimension changes
// ------------------------------
timeDimension.on("timechange", function(e) {
  const currentTime = e.time; // ms since epoch
  const idx = timeMs.indexOf(currentTime);
  if (idx === -1 || idx === currentIndex) {
    return;
  }

  currentIndex = idx;
  currentEncodedUrl = buildEncodedCogUrl(cogFiles[currentIndex]);

  console.log("Timechange -> showing:", cogLabels[currentIndex]);
  cogLayer.setUrl(makeCogUrl(currentEncodedUrl));
});
</script>
</body>
</html>
