<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DFW Sectionals – TimeDimension</title>

  <!-- Leaflet core -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- TimeDimension CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.css"
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- TimeDimension deps -->
<script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.min.js"></script>

<script>
// ------------------------------
// TiTiler base URL
// ------------------------------
const titiler = "https://titiler-production.up.railway.app";

// ------------------------------
// Editions: filenames & labels
// ------------------------------
const editions = [
  { filename: "201109N_geo_COG.tif", label: "2011 N" },
  { filename: "201109S_geo_COG.tif", label: "2011 S" },
  { filename: "201209N_geo_COG.tif", label: "2012 N" },
  { filename: "201209S_geo_COG.tif", label: "2012 S" },
  { filename: "201309N_geo_COG.tif", label: "2013 N" },
  { filename: "201309S_geo_COG.tif", label: "2013 S" }, // ensure this is really .tif
  { filename: "201403_geo_COG.tif", label: "2014" },
  { filename: "201503_geo_COG.tif", label: "2015" },
  { filename: "201603_geo_COG.tif", label: "2016-03" },
  { filename: "201609_geo_COG.tif", label: "2016-09" }
];

// ------------------------------
// Helper: build aeromap.io encoded URL
// ------------------------------
function buildEncodedCogUrl(filename) {
  const url = `https://aeromap.io/${filename}`;
  return encodeURIComponent(url);
}

// ------------------------------
// Helper: derive ISO time from filename: YYYYMM -> YYYY-MM-01T00:00:00Z
// ------------------------------
function dateFromFilename(filename) {
  const match = filename.match(/^(\d{4})(\d{2})/);
  if (!match) return null;
  const year = match[1];
  const month = match[2];
  return `${year}-${month}-01T00:00:00Z`;
}

const timeStrings = editions.map(e => dateFromFilename(e.filename));
const timeMs = timeStrings.map(t => new Date(t).getTime());

// ------------------------------
// TimeDimension object
// ------------------------------
console.log("L.TimeDimension is", typeof L.TimeDimension);
const timeDimension = new L.TimeDimension({
  times: timeStrings.join(','),
  currentTime: timeMs[0]
});

// ------------------------------
// Create basic map (we'll fit to COG bounds later)
// ------------------------------
const map = L.map("map", {
  worldCopyJump: false,
  timeDimension: timeDimension,
  timeDimensionControl: false
});

// OSM basemap
const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 22,
    noWrap: true
  }
).addTo(map);

// TimeDimension control with year-only label
const timeDimensionControl = new L.Control.TimeDimension({
  position: "bottomleft",
  playerOptions: {
    transitionTime: 1000,
    loop: true,
    startOver: true
  }
});
timeDimensionControl.addTo(map);

timeDimensionControl._getDisplayDateFormat = function(date) {
  return date.getUTCFullYear().toString();
};

// ------------------------------
// SINGLE COG tile layer – URL swapped per time step
// ------------------------------
let currentIndex = 0;
let currentEncodedUrl = buildEncodedCogUrl(editions[currentIndex].filename);

function makeCogUrl(encoded) {
  // Using WebMercatorQuad tiles from TiTiler
  return `${titiler}/cog/tiles/WebMercatorQuad/{z}/{x}/{y}.png?url=${encoded}`;
}

const cogLayer = L.tileLayer(makeCogUrl(currentEncodedUrl), {
  tileSize: 256,
  maxZoom: 22,
  noWrap: true,
  keepBuffer: 1,
  updateWhenIdle: true
}).addTo(map);

// When time changes, swap the COG URL
timeDimension.on("timechange", function(e) {
  const currentTime = e.time;
  const idx = timeMs.indexOf(currentTime);
  if (idx === -1 || idx === currentIndex) return;

  currentIndex = idx;
  currentEncodedUrl = buildEncodedCogUrl(editions[currentIndex].filename);
  console.log("Switching to edition:", editions[currentIndex].filename);
  cogLayer.setUrl(makeCogUrl(currentEncodedUrl));
});

// ------------------------------
// Fit map to COG bounds in WGS84 and clamp zooms
// ------------------------------
const firstEncoded = buildEncodedCogUrl(editions[0].filename);

// 1) Get bounds in WGS84 to position the map correctly
fetch(`${titiler}/cog/bounds?url=${firstEncoded}`)
  .then(r => r.json())
  .then(b => {
    console.log("COG bounds (WGS84):", b);
    if (b && Array.isArray(b.bounds) && b.bounds.length === 4) {
      const [minX, minY, maxX, maxY] = b.bounds; // [west, south, east, north]
      const sw = [minY, minX];
      const ne = [maxY, maxX];
      const latLngBounds = L.latLngBounds(sw, ne);

      map.fitBounds(latLngBounds);
      map.setMaxBounds(latLngBounds.pad(0.1)); // keep panning near the map
    }
  })
  .catch(err => console.error("cog/bounds error:", err));

// 2) Get zoom constraints (optional)
fetch(`${titiler}/cog/info?url=${firstEncoded}`)
  .then(r => r.json())
  .then(info => {
    console.log("First COG info:", info);
    if (typeof info.minzoom === "number" && typeof info.maxzoom === "number") {
      map.setMinZoom(info.minzoom);
      map.setMaxZoom(info.maxzoom);

      const currentZoom = map.getZoom();
      if (currentZoom < info.minzoom || currentZoom > info.maxzoom) {
        map.setZoom(info.minzoom + 1);
      }
    }
  })
  .catch(err => console.error("cog/info error:", err));
</script>
</body>
</html>
